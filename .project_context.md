# Contexto del Proyecto: Google Photos Backup (GPB)

PROMPT: Eres un experto en GO que vas a ir guiando al usuario para desarrollar una aplicación. Al principio de una sesión de desarrollo leerás este fichero y seguirás las instrucciones aquí. Guiarás al usuario para crear un branch en git para la siguiente feature, desarrollarla con go, actualizar este fichero con los resultados, subir los cambios a git (y hacer el pull request y merge) y con eso terminar la sesión.

## 1. Descripción y Objetivos
Aplicación CLI para Linux/macOS que automatiza la creación y descarga de copias de seguridad de Google Photos utilizando **Google Takeout**.
*   **Takeout Automation:** Usa Go-Rod para solicitar backups en Google Takeout, monitorizarlos y descargarlos.
*   **Post-Procesado:** Descomprime, une metadatos (JSON) con archivos (EXIF/Fechas) y organiza por álbumes.
*   **Headless:** Configurable vía archivos (`/etc/` o `~/.config/`).

## 2. Requerimientos Originales (User Specs)
- Aplicación CLI sin interfaz gráfica (Linux/Mac).
- Configuración mediante ficheros en `/etc/` o home.
- Leerá los datos necesarios del fichero de configuración.
- **Configurador:** Lanzará un navegador (Go-Rod) para que el usuario inicie sesión en Google. La sesión (cookies) se guardará para futuras ejecuciones headless.
- **Backup (Takeout):** Automatizará la solicitud de un Takeout de Google Photos.
- **Descarga:** Monitorizará el estado y descargará los ZIPs resultantes.
- **Procesamiento:**
    - Descomprimir ZIPs.
    - **Fix Metadata:** Leer los JSON sidecar de Takeout y aplicar la fecha correcta de creación/modificación al archivo y corregir EXIF si es necesario.
    - **Organización:** Recrear la estructura de álbumes usando enlaces simbólicos (para no duplicar espacio si una foto está en varios álbumes).
- **Incremental:** Capacidad de gestionar nuevos Takeouts y fusionarlos con el backup existente.
- Usaré MacOs con visual studio para el desarrollo. Cuando esté terminado, lo portaré a linux.

## 3. Arquitectura Técnica
*   **Language**: Go (1.25+)
*   **CLI Library**: Cobra
*   **Configuration**: Viper (`~/.config/google-photos-backup/config.yaml`)
*   **Browser Automation**: go-rod (Login, Takeout Request, Download).
*   **Metadata Engine**: Lógica propia para parsear JSONs de Takeout y usar `exiftool` o similar (o librerías nativas Go) para corregir ficheros.

## 4. Estado del Proyecto
**Fase Actual:** Fase 3 - Monitorización y Descarga.

### Completado:
*   [x] Estructura del proyecto y configuración (Viper).
*   [x] Internacionalización (i18n).
*   [x] **Fase 1:** Infraestructura Go-Rod (`internal/browser`).
    *   [x] Gestor de navegador y persistencia de sesión (cookies).
    *   [x] Comando `configure` actualizado para login manual en navegador.
*   [x] **Fase 2:** Automatización Takeout (Solicitud).
    *   [x] Navegar a takeout.google.com.
    *   [x] Seleccionar solo Google Photos.
    *   [x] Solicitar exportación.
*   [x] **Fase 3 (Parcial):** Monitorización.
    *   [x] Detección de exportaciones en curso.
    *   [x] Sistema de registro (`history.json`) con formato JSONL.
    *   [x] Lógica de frecuencia de copias (evitar solicitudes duplicadas).
    *   [x] Cancelación de exportaciones antiguas.
    *   [x] Filtrado correcto de múltiples exportaciones en curso.

### Pendiente (Hoja de Ruta):
*   [ ] **Fase 3 (Continuación):** Descarga.
    *   Detectar exportaciones completadas ("Download" button).
    *   Obtener enlaces de descarga.
    *   Descargar ZIPs.
    *   Descomprimir.
*   [ ] **Fase 4:** Procesamiento y Organización.
    *   Unificar JSONs con media.
    *   Organizar por álbumes.

## 5. Referencia de Archivos
*   `cmd/`: Entry points for commands (`configure`, `sync`, `root`).
*   `internal/browser/`: (Nuevo) Lógica de automatización con Go-Rod.
*   `internal/config/`: Configuration management.
*   `internal/i18n/`: Internationalization.
*   `internal/utils/`: Utilities (browser opener).
*   `internal/processor/`: (Nuevo) Lógica de procesamiento de Takeout (EXIF, Renombrado).

## 6. Workflow & Reglas AI
1.  **Ramas:** Crear rama por feature (`git checkout -b feature/<nombre>`). Cuando el usuario empieza a trabajar, decirle que debe crear un branch. Cuando acabe de trabajar en la feature, decirle que debe hacer el add, commit y push y luego hacer el pull request y el merge y eliminar el branch.
2.  **Commits:** Mensajes semánticos (`feat:`, `fix:`, `docs:`).
3.  **Documentación:**
    *   Mantener paridad `README.md` (EN) y `README.es.md` (ES).
4.  **Contexto:** Actualizar este archivo si cambian objetivos o estado. Hacerlo al final de cada desarrollo, cuando el usuario vaya a hacer un commit para iniciar un nuevo branch. 
5. Al principio de cada sesión revisar todos los ficheros en el directorio raiz y comprobar el estado de desarrollo y que coincide con lo indicado en este fichero de contexto.

## 7. Comandos de Desarrollo
```bash
# Compilar
go build -o gpb main.go

# Configurar
./gpb configure

# Ejecutar Sync
./gpb sync
```
