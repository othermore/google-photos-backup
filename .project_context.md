# Contexto del Proyecto: Google Photos Backup (GPB)

## 1. Descripción y Objetivos
Aplicación CLI para Linux/macOS que realiza backups incrementales de Google Photos en calidad original.
*   **Híbrido:** Usa API para metadatos y Scraping (Go-Rod) para descargar "Original Quality".
*   **Incremental:** Usa `index.jsonl` para evitar duplicados.
*   **Headless:** Configurable vía archivos (`/etc/` o `~/.config/`).

## 2. Requerimientos Originales (User Specs)
- Aplicación CLI sin interfaz gráfica (Linux/Mac).
- Configuración mediante ficheros en `/etc/` o home.
- Leerá los datos necesarios del fichero de configuración: usuario, clave de API y cualquier otra cosa que haga falta
- Dispondrá de una herramienta configurador que pedirá los datos necesarios y los almacenará en el fichero de configuración y que, cuando sea necesario, lanzará un navegador web para logarse con la cuenta de google y dar permisos a la aplicación para acceder con ese usuario
- Creará copia de seguridad de todas las imágenes y vídeos de google photos
- Guardará un índice para saber de qué imágenes ya se ha creado copia de seguridad y no tener que estar comprobando una por una, y solo añadir las nuevas.
- Ese índice también le permitirá marcar imágenes de las que hay un backup pero se han eliminado de google photos, para que el usuario pueda comprobarlas y ver si quiere mantenerlas o eliminarlas
- Tendrá una opción para actualizar el índice, que comprobará (a) si se han eliminado ficheros en el backup y en ese caso los borrará del índice, (b) si se han eliminado fotos de google photos, en cuyo caso los marcará en el índice como eliminados de google photos y (c) si se han añadido nuevas fotos a google photos, en cuyo caso las añadirá en el índice como pendientes de descarga.
- Tendrá una opción para rehacer el índice, que volverá a usar la API y todos los archivos para crear el índice indicando que imágenes se han borrado en google photos y qué imágenes ya hay copia de seguridad, y de cuales no hay aún copia de seguridad (pero ya están en google photos)
- Tendrá una opción para descargar las fotos que estén pendientes de descarga según el índice
- Tendrá una opción para eliminar del backup las fotos que se hayan eliminado de google drive. Salvo que se use una opción de Force, esta opción preguntará imagen por imagen y permitirá ver las imágenes (abriendo una aplicación para mostrarla) para que el usuario pueda decidir si las elimina o no
- Tendrá una opción para realizar o actualizar el backup. Esta es la opción principal y es la que se usará desde un cron de forma regular
- No quiero usar SQLite. ¿Es neecesario? Si es posible y no hay una diferencia muy importante, preferiría guardar los índices en ficheros planos (cada linea una foto, con sus propiedades o similar). ¿qué te parece?
- Sí o sí habrá que usar algún tipo de scrapping. Ya he comprobado que la API no permite descargar los ficheros originales a máxima calidad
- Usaré MacOs con visual studio para el desarrollo. Cuando esté terminado, lo portaré a linux.

## 3. Arquitectura Técnica
*   **Language**: Go (1.25+)
*   **CLI Library**: Cobra
*   **Configuration**: Viper (`~/.config/google-photos-backup/config.yaml`)
*   **Browser Automation**: go-rod (Connects to Chrome/Chromium)
*   **Data Storage**: Local JSONL index (`index.jsonl`) to track downloaded IDs.

## 4. Estado del Proyecto
**Fase Actual:** Fase 4 - Cliente API y Comando Sync.

### Completado (Fases 1-3):
*   [x] Estructura del proyecto y configuración (Viper).
*   [x] Internacionalización (i18n).
*   [x] Autenticación OAuth2 (`internal/auth`): Servidor local + Token storage.

### Pendiente (Hoja de Ruta):
*   [ ] **Fase 4 (INMEDIATO):** Cliente API y Comando Sync.
    *   **Index:** Implementar carga/guardado en `internal/index/store.go` (actualmente es un esqueleto).
    *   **Sync:** Completar `cmd/sync.go` (actualmente solo lista 10 items). Faltan: paginación, integración con índice, lógica incremental.
    *   **API:** Verificar que `internal/api` soporta paginación correctamente.
*   [ ] **Fase 5:** Implementar `internal/downloader` con Go-Rod.
    *   Instanciar navegador.
    *   Navegar a URL, gestionar login/cookies.
    *   Descargar archivo.
*   [ ] **Fase 6:** Lógica del Índice (`internal/index`).
    *   Comparar API vs Local.
    *   Filtrar ya descargados.
*   [ ] **Fase 7:** Empaquetado (.deb, .rpm).

## 5. Referencia de Archivos
*   `cmd/`: Entry points for commands (`configure`, `sync`, `root`).
*   `internal/api/`: Google Photos API client (Listing, Metadata).
*   `internal/auth/`: OAuth2 authentication.
*   `internal/config/`: Configuration management.
*   `internal/i18n/`: Internationalization.
*   `internal/utils/`: Utilities (browser opener).
*   `internal/downloader/`: (Pendiente) Browser automation logic.
*   `internal/index/`: Local database logic.

## 6. Workflow & Reglas AI
1.  **Ramas:** Crear rama por feature (`git checkout -b feature/<nombre>`).
2.  **Commits:** Mensajes semánticos (`feat:`, `fix:`, `docs:`).
3.  **Documentación:**
    *   Mantener paridad `README.md` (EN) y `README.es.md` (ES).
    *   Actualizar lista de archivos en README si se crean/borran ficheros.
4.  **Contexto:** Actualizar este archivo si cambian objetivos o estado.

## 7. Comandos de Desarrollo
```bash
# Compilar
go build -o gpb main.go

# Configurar
./gpb configure

# Ejecutar Sync
./gpb sync
```
